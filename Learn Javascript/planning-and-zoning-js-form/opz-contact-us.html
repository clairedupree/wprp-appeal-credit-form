<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
      integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://www.aacounty.org/_template-assets/css/bootstrap4-iso.min.css" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="https://www.google.com/recaptcha/api.js?render=6LcZ7_8UAAAAAM3vtVvjvtizev-EFEZfug9jirUa"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <style>
      .dropdown-menu {
        position: relative !important;
        width: 100%;
        overflow: visible !important;
        transform: translate3d(0px, 35px, 0px) !important;
        top: -40px !important;
      }
      .requiredField {
        color: red;
      }
      .row {
        background: none !important;
        border-top: 0px !important;
        margin: auto !important;
      }

      .ui-autocomplete {
        max-height: 150px;
        overflow-y: auto;
        overflow-x: hidden;
        font-size: 10pt;
        z-index: 999;
      }
      * html .ui-autocomplete {
        height: 100px;
      }
    </style>
  </head>
  <body>
    <div class="bootstrap-iso" id="optionDiv"></div>
    <div class="bootstrap-iso" id="messageDiv" style="display: none">
      <h3>Thank you for your form submission.</h3>
      <!-- <h3>Thank you for your form submission. You will receive a response....[enter message here].</h3> -->
      <!-- <h4><a href="location.reload">Submit additional question</a></h4> -->
    </div>
    <div class="bootstrap-iso" id="cmForm" style="display: none">
      <form id="opzForm" class="form">
        <div class="row">
          <!-- Your Information -->
          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12" style="margin-bottom: 10px">
            <h5>Your Information</h5>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6">
            <div class="form-group">
              <label>First Name:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="constituentFirstName" name="constituentFirstName" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6">
            <div class="form-group">
              <label>Last Name:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="constituentLastName" name="constituentLastName" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6">
            <div class="form-group">
              <label>Email Address:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="email" class="form-control valid" id="emailAddress" name="emailAddress" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6">
            <div class="form-group">
              <label>Phone Number:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="constituentPhone" name="constituentPhone" required />
            </div>
          </div>
          <!-- address -->
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>House Number:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="ownerHouseNumber" name="ownerHouseNumber" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>Street Name:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="ownerStreetName" name="ownerStreetName" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>Street Type:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="ownerStreetType" name="ownerStreetType" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>City:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="ownerCity" name="ownerCity" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>State:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="ownerState" name="ownerState" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>Zip:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="ownerZip" name="ownerZip" required />
            </div>
          </div>
          <!-- address -->
          <!-- Your Information -->
          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12" style="margin-bottom: 10px; margin-top: 10px">
            <h5>Property Information</h5>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6" style="margin-bottom: 10px">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="setAddress" name="sameAddress" style="margin-left: -1rem" />
              <label class="form-check-label" for="setAddress" style="margin-left: 8px">Set to same address as above</label>
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-6 col-xl-6" style="margin-bottom: 10px">
            <div class="form-check">
              <input type="checkbox" class="form-check-input" id="setUnknownAddress" name="unknownAddress" style="margin-left: -1rem" />
              <label class="form-check-label" for="setUnknownAddress" style="margin-left: 8px">Address Unknown</label>
            </div>
          </div>
          <!-- address2 -->
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>House Number:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="locationHouseNumber" name="locationHouseNumber" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>Street Name:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="locationStreetName" name="locationStreetName" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>Street Type:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="locationStreetType" name="locationStreetType" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>City:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="locationCity" name="locationCity" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>State:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="locationState" name="locationState" required />
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-4 col-xl-4">
            <div class="form-group">
              <label>Zip:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="locationZip" name="locationZip" required />
            </div>
          </div>
          <!-- address2 -->
          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
            <div class="form-group">
              <label>Subject:&nbsp;&nbsp;</label><span class="requiredField">*</span>
              <input type="text" class="form-control valid" id="subject" name="subject" required />
            </div>
          </div>

          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
            <div class="form-group">
              <label>Is the address in the Critical Area?:&nbsp;&nbsp;</label>
              <div class="form-check form-check-inline">
                <label class="form-check-label"
                  ><input class="form-check-input" type="radio" id="criticalAreaYes" name="criticalArea" value="yes" />Yes</label
                >
              </div>
              <div class="form-check form-check-inline">
                <label class="form-check-label"
                  ><input class="form-check-input" type="radio" id="criticalAreaNo" name="criticalArea" value="no" />No</label
                >
              </div>
            </div>
          </div>

          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
            <div class="form-group">
              <label>Comment:</label>
              <textarea class="form-control" id="comment" name="comment" placeholder="" rows="5"></textarea>
            </div>
          </div>
          <div class="col-sm-12 col-md-12 col-lg-12 col-xl-12">
            <p>Fields marked with <span style="color: red">*</span> are required.</p>
            <br />
            <button class="btn btn-primary" type="submit" value="SUBMIT" id="submitbtn">Submit Form</button>
          </div>
        </div>
      </form>
    </div>
  </body>

  <script type="text/javascript">
    var optionsJson = '';
    var topics = [];
    var locationHouseNumber;
    var locationStreetName;
    var locationStreetType;
    var locationCity;
    var locationState;
    var locationZip;
    var selectedTopics = '';
    var instructions = '';
    let jsonData = {};

    $(document).ready(function () {
      $.getJSON('https://www.aacounty.org/departments/planning-and-zoning/contact-us/opz-contact-us.js', function (data) {
        optionsJson = data;
        loadInitial();
        $('#address').val('');
        $('#address').autocomplete({
          source: function (request, response) {
            $.ajax({
              url: 'https://aacoprod.aacounty.org/AACOServicePublic/rest/GetAddress/' + request.term,
              async: false,
              dataType: 'jsonp',
              success: function (data) {
                if (data.length == 0) {
                  response(['No Results Found']);
                } else {
                  response(
                    $.map(data, function (item) {
                      return {
                        label: item.streetNumber + ' ' + item.streetName + ' ' + item.suffix + ' ' + item.cityName + ', MD ' + item.zipCode,
                        value: item.streetNumber + ' ' + item.streetName + ' ' + item.suffix + ' ' + item.cityName + ', MD ' + item.zipCode,
                        formattedAddr:
                          item.streetNumber + ' ' + item.streetName + ' ' + item.suffix + '<br>' + item.cityName + ', MD ' + item.zipCode,
                        streetNumber: item.streetNumber,
                        streetName: item.streetName,
                        suffix: item.suffix,
                        cityName: item.cityName,
                        zipCode: item.zipCode,
                        x: item.x,
                        y: item.y,
                      };
                    })
                  );
                }
              },
            });
          },
          minLength: 4,
          select: function (event, ui) {
            locationHouseNumber = ui.item.streetNumber;
            locationStreetName = ui.item.streetName;
            locationStreetType = ui.item.suffix;
            locationCity = ui.item.cityName;
            locationState = 'MD';
            locationZip = ui.item.zipCode;
          },
        });
      });
    });

    function loadInitial() {
      $('#cmForm').hide();
      var markup =
        instructions +
        '<div class="dropdown"><button class="btn btn-dark btn-block dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
        optionsJson.label +
        '</button><div class="dropdown-menu" id="optionDrop" aria-labelledby="dropdownMenuButton"></div></div>';
      $('#optionDiv').html(markup);
      for (var x = 0; x < optionsJson.options.length; x++) {
        $('#optionDrop').append(
          '<a class="dropdown-item" href="javascript:load(\'option-' + x + '\')">' + optionsJson.options[x].value + '</a>'
        );
      }
    }

    $('input[name=sameAddress]').change(function () {
      if ($(this).is(':checked')) {
        $('#setUnknownAddress').prop('checked', false);
        $('#locationHouseNumber').val($('#ownerHouseNumber').val());
        $('#locationStreetName').val($('#ownerStreetName').val());
        $('#locationStreetType').val($('#ownerStreetType').val());
        $('#locationCity').val($('#ownerCity').val());
        $('#locationState').val($('#ownerState').val());
        $('#locationZip').val($('#ownerZip').val());
      } else {
        $('#locationHouseNumber').val('');
        $('#locationStreetName').val('');
        $('#locationStreetType').val('');
        $('#locationCity').val('');
        $('#locationState').val('');
        $('#locationZip').val('');
      }
    });
    // set address to Unkown
    $('input[name=unknownAddress]').change(function () {
      if ($(this).is(':checked')) {
        $('#setAddress').prop('checked', false);
        $('#locationHouseNumber').val('Unknown');
        $('#locationStreetName').val('Unknown');
        $('#locationStreetType').val('Unknown');
        $('#locationCity').val('Unknown');
        $('#locationState').val('Unknown');
        $('#locationZip').val('Unknown');
      } else {
        $('#locationHouseNumber').val('');
        $('#locationStreetName').val('');
        $('#locationStreetType').val('');
        $('#locationCity').val('');
        $('#locationState').val('');
        $('#locationZip').val('');
      }
    });

    function load(index) {
      $('#cmForm').hide();
      var layers = index.split('-')[1].split('.');
      var selected = '';
      topics = [];
      var selectedJson = optionsJson;
      var layerIndex = 'option-';
      for (var i = 0; i < layers.length; i++) {
        var loadFunction = '';
        if (i == 0) {
          loadFunction = 'loadInitial()';
          layerIndex += +layers[i];
        } else {
          loadFunction = 'load("' + layerIndex + '")';
          layerIndex += '.' + layers[i];
        }
        selected +=
          "<span class='badge badge-pill badge-primary' style='margin-right:10px;margin-bottom:10px;font-size:12pt;background-color:#0072bc;'>" +
          selectedJson.options[layers[i]].value +
          "<i style='margin-left:10px;cursor:pointer;' class='fas fa-times' onclick='" +
          loadFunction +
          "'></i></span>";
        topics.push(selectedJson.options[layers[i]].value);

        if (i + 1 == layers.length) {
          if (selectedJson.options[layers[i]].response) {
            selected += '<hr><p>' + selectedJson.options[layers[i]].response + '</p>';
            $('#optionDiv').html(selected);
          } else if (selectedJson.options[layers[i]].options) {
            selected +=
              '<div class="dropdown"><button class="btn btn-dark btn-block dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
              selectedJson.options[layers[i]].label +
              '</button><div class="dropdown-menu" id="optionDrop" aria-labelledby="dropdownMenuButton"></div></div>';
            $('#optionDiv').html(selected);
            for (var x = 0; x < selectedJson.options[layers[i]].options.length; x++) {
              $('#optionDrop').append(
                '<a class="dropdown-item" href="javascript:load(\'' +
                  index +
                  '.' +
                  x +
                  '\')">' +
                  selectedJson.options[layers[i]].options[x].value +
                  '</a>'
              );
            }
          } else {
            $('#cmForm').show();
            $('#optionDiv').html(instructions + selected);
          }
        }
        selectedJson = selectedJson.options[layers[i]];
      }
    }

    // Post with  axios
    function PostToCaseManager() {
      // let url = 'https://cmtest.aacounty.org/genericCase/createCaseFromJsonData';
      let url = 'https://issueflow.aacounty.org/caseManagerDirect';
      let config = {
        headers: {
          Authorization: '933540812E9970aB83486CA5m06Bte126BD5Faf523F',
        },
      };
      axios
        .post(url, jsonData, config)
        .then(function (response) {
          console.log(response);
          $('#cmForm').hide();
          $('#optionDiv').hide();
          $('#messageDiv').show();
          $('#messageDiv')[0].scrollIntoView(true);
        })
        .catch(function (error) {
          console.log({ error: error, message: 'Error posting to CM' });
        });
    }

    const form = document.getElementById('opzForm');
    form.addEventListener('submit', (e) => {
      let formId = '';
      e.preventDefault();
      var currentPage = location.href;
      grecaptcha.ready(function () {
        grecaptcha
          .execute('6LcZ7_8UAAAAAM3vtVvjvtizev-EFEZfug9jirUa', {
            action: 'submit',
          })
          .then(function (token) {
            // jsonData['caseTypeUUID'] = '3c1eb0ad-f923-4b31-8aae-4d9591462d7f';
            jsonData['caseTypeUUID'] = '3c1eb0ad-f923-4b31-8aae-4d9591462d7f';
            field = {};
            field['token'] = token;
            field['criticalArea'] = $('input[name="criticalArea"]:checked').val() === 'yes' ? true : false;
            field['constituentFirstName'] = $('#constituentFirstName').val();
            field['constituentLastName'] = $('#constituentLastName').val();
            field['email'] = $('#emailAddress').val();
            field['locationHouseNumber'] = $('#locationHouseNumber').val();
            field['locationStreetName'] = $('#locationStreetName').val();
            field['locationStreetType'] = $('#locationStreetType').val();
            field['locationCity'] = $('#locationCity').val();
            field['locationState'] = $('#locationState').val();
            field['locationZip'] = $('#locationZip').val();
            field['constituentPhone'] = $('#constituentPhone').val();
            // new
            field['ownerHouseNumber'] = $('#ownerHouseNumber').val();
            field['ownerStreetName'] = $('#ownerStreetName').val();
            field['ownerStreetType'] = $('#ownerStreetType').val();
            field['ownerCity'] = $('#ownerCity').val();
            field['ownerState'] = $('#ownerState').val();
            field['ownerZip'] = $('#ownerZip').val();
            // new
            field['summary'] = topics;
            field['subject'] = $('#subject').val();
            field['description'] = $('#comment').val();
            jsonData['jsonData'] = field;
            PostToCaseManager();
          });
      });
    });
  </script>
</html>
